<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Line & Stop Selector</title>  
  <style>

    @font-face {
        font-family: PFDinDisplayPro-Regular;
        src: url("resources/PFDinDisplayPro-Regular.ttf");
    }

    @keyframes lineSeparatorAppears {
      0% {
        background: linear-gradient(90deg,rgba(255, 0, 0, 1) 0%, rgba(255, 0, 0, 1) 100%, rgba(255, 85, 85, 1) 100%, rgba(255, 85, 85, 1) 100%, rgba(255, 170, 170, 1) 100%, rgba(255, 170, 170, 1) 100%);
      }
      100%{
        background: linear-gradient(90deg,rgba(255, 0, 0, 1) 0%, rgba(255, 0, 0, 1) 50%, rgba(255, 85, 85, 1) 50%, rgba(255, 85, 85, 1) 75%, rgba(255, 170, 170, 1) 75%, rgba(255, 170, 170, 1) 100%);
      }
    }

    body { 
      font-family: PFDinDisplayPro-Regular, sans-serif;
      color: white;
      background-color: #333;
      padding: 20px; 

    }
    h1 {
      margin: 0;
      margin-bottom: 0.5rem; 
    }
    .section {
      background-color: #484848;
      padding: 1em;
    }
    h3 { 
      margin: 0;
      margin-bottom: 0.5em; 
      background-color: #414141;
    }
    .lineSeparator{
      height: 1em;
      width: 100%;
      margin-bottom: 1em;
      /* animation: 1s ease-in 0s 1 forwards running lineSeparatorAppears; */
      background: linear-gradient(90deg,rgba(255, 0, 0, 1) 0%, rgba(255, 0, 0, 1) 50%, rgba(255, 85, 85, 1) 50%, rgba(255, 85, 85, 1) 75%, rgba(255, 170, 170, 1) 75%, rgba(255, 170, 170, 1) 100%);
    }
    select, input { margin: 5px 0; width: 300px; }
    input[type="checkbox"] {
      -webkit-appearance: none;
      appearance: none; 
      width: auto !important;
    }
    #search{
      box-sizing: border-box;
      width: 100%;
      margin-bottom: 2px;
    }
    #stationSelect {
      padding: 1px 2px;
    }
    .stationSelectCustom {
      padding: 2px 1px 2px 4px; /* take accnt of 11px of scrollbar to the right*/
      height: 7em;
      width: calc(100% - 8px); 
      background: white;
      overflow: scroll;
      color: black;
      font-size: 0.85rem;
      border: #767676 1px solid;
      border-radius: 2px;
    }
    .stationSelectOption {
      /* padding-inline: 10px; */
      padding: 1px;
      cursor: pointer;
      user-select: none;
    }
    .stationSelectOption.selected{
      background-color: #b3d7ff;
    }

    .stationSelectCustom::-webkit-scrollbar {
        -webkit-appearance: none;
    }

    .stationSelectCustom::-webkit-scrollbar:vertical {
        width: 11px;
    }

    .stationSelectCustom::-webkit-scrollbar:horizontal {
        height: 0px;
    }

    .stationSelectCustom::-webkit-scrollbar-thumb {
        border-radius: 8px;
        border: 2px solid white; /* should match background, can't be transparent */
        background-color: rgba(0, 0, 0, .5);
    }

    #lineSelectContainer {
      display: flex;
      height: 35px;
      /* overflow: hidden; */
    }
    #lineSelectContainer label { 
      display: block;
      width: 35px;
      height: 35px;
      margin-right: 10px;
      transition: transform 100ms ease-in-out;
    }
    input[type="checkbox"]:checked + label {
      transform: scale(1.2);
    }
    label .circle {
      display: inline-block;
      box-sizing: border-box;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      overflow: hidden;
      transition: border 100ms ease-in-out;
    }
    input[type="checkbox"]:checked + label .circle {
      border: 4px solid green;
    }
    label img { 
      width: 100%;
      height: 100%;
      transition: transform 100ms ease-in-out;
    }
    input[type="checkbox"]:checked + label .circle img {
      transform: scale(1.1);
    }

    button {
      font-weight: 400;
      font-family: PFDinDisplayPro-Regular,sans-serif;
      font-size: 1rem;
      line-height: 1.4rem;
      text-transform: uppercase;
      background-color: #767676;
      border-radius: .25rem;
      border: none;
      display: inline-block;
      color: #fff;
      min-width: 12rem;
      text-align: center;
      margin: 0 auto .7rem;
      padding: .6rem;
      -webkit-tap-highlight-color: #858585;
    }

    button:not(:disabled) {
      background-color: #ff4700;
      -webkit-tap-highlight-color: red;
    }

    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Next Train Watchface</h1>
  <div class="lineSeparator"></div>
  <h2>Select Station #1</h3>
  <div class="section">
    <h3>Select Station</h3>
    <hr>
    <span>From line...</span>
    <br>
    <label>
      <select id="lineSearch">
        <option value="">Select a line</option>
      </select>
    </label>
    <br>
    <input type="text" id="search" placeholder="Search stations..." class="hidden" />
    <br>
    <!-- <select id="stationSelect" size="6" class="hidden"></select> -->
    <div class="stationSelectCustom hidden" id="stationSelectCustom" tabindex="0">
      <!-- <div class="custom-select-option" data-value="1">Option 1</div> -->
    </div>
    <input type="hidden" name="stationValue" id="stationValue">
    <input type="hidden" name="stationName" id="stationName">
  </div>
  <br>
  <div class="section">
    <h3>Select Trains</h3>
    <hr>
    <div id="lineSelectContainer" class="hidden">
    </div>
  </div>
  <br>

  <div class="section">
    <h3>Select Direction</h3>
    <hr>
    <div id="directionContainer" class="hidden">
      <label>
        <select id="directionSelect">
          <option value="">Select direction</option>
          <option value="N">North (N)</option>
          <option value="S">South (S)</option>
        </select>
      </label>
    </div>
  </div>
  <br>

  <button id="submitBtn" disabled>Submit</button>

 <script>
async function fetchCSV(url) {
  const response = await fetch(url);
  const text = await response.text();
  
  return text.split("\n").slice(1).map(row => {
    const values = row.split(",");
    return values;
  });
}

async function loadData() {
  const rawLines = await fetchCSV("lines.csv");
  const rawStops = await fetchCSV("stations.csv");

  // Convert CSV to objects
  const lines = rawLines.map(row => ({
    id: row[1],  // route_id
    name: row[3], // route_long_name
    direction_N: row[5], // route_direction_N (start station)
    direction_S: row[6], // route_direction_S (end station)
  }));

  const stops = rawStops.map(row => ({
    id: row[0],  // stop_id
    name: row[5], // stop_name
    lines: row[8] ? row[8].split(" ").map(line => ({ id: line })) : [], // Safety check
    direction_N: row[12],
    direction_S: row[13]
  }));


  initializeDropdown(lines, stops);
}

function initializeDropdown(lines, stops) {
  const lineSearch = document.getElementById("lineSearch");
  const searchInput = document.getElementById("search");
  // const stationSelect = document.getElementById("stationSelect");
  const stationSelectCustom = document.getElementById("stationSelectCustom");
  const stationValue = document.getElementById("stationValue");
  const stationName = document.getElementById("stationName");
  const lineSelectContainer = document.getElementById("lineSelectContainer");
  const directionContainer = document.getElementById("directionContainer");
  const directionSelect = document.getElementById("directionSelect");
  const submitBtn = document.getElementById("submitBtn");

  let filteredStops = [];

  // --- Populate Line Dropdown ---
  lines.forEach(line => {
    const option = document.createElement("option");
    option.value = line.id;
    option.textContent = `${line.id} - ${line.name}`;
    lineSearch.appendChild(option);
  });

  lineSearch.addEventListener("change", () => {
    const selectedLine = lines.find(line => line.id === lineSearch.value);
    
    lineSelectContainer.innerHTML = "";

    if (selectedLine) {
      // Filter stops within the line's route (start and end station included)
      const startStop = selectedLine.direction_N;
      const endStop = selectedLine.direction_S;

      const lineID = selectedLine.id

      filteredStops = stops.filter(stop => 
        stop.lines.some(line => line.id === lineID)
      );

      renderStationOptions();
      searchInput.classList.remove("hidden");
      stationSelectCustom.classList.remove("hidden");
      directionContainer.classList.remove("hidden");
      searchInput.value = "";

      submitBtn.disabled = true;
       
    } else {
      searchInput.classList.add("hidden");
      stationSelectCustom.classList.add("hidden");
      directionContainer.classList.add("hidden");
      submitBtn.disabled = true;
    }
  });

  searchInput.addEventListener("input", () => {
    renderStationOptions(searchInput.value);
  });

  stationValue.addEventListener("change", () => {
    if (stationValue) {
      const selectedLine = lines.find(line => line.id === lineSearch.value);
      const selectedStop = stops.find(stop => stop.id === stationValue.value);

      // Clear and repopulate radio buttons
      lineSelectContainer.innerHTML = "";

      if (selectedStop.lines) {
        lineSelectContainer.classList.remove("hidden");

        selectedStop.lines.forEach(line => {
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.name = "line";
          checkbox.value = line.id;
          checkbox.id = `line-${line.id}`;

          const label = document.createElement("label");
          label.htmlFor = checkbox.id;
          const circle = document.createElement("span");
          circle.classList.add("circle");
          const icon = document.createElement("img");
          icon.src = "lineIcons/"+line.id+".svg";

          lineSelectContainer.appendChild(checkbox);
          lineSelectContainer.appendChild(label);
          label.appendChild(circle);
          circle.appendChild(icon);
        });
      } else {
        lineSelectContainer.classList.add("hidden");
      }

      directionSelect.innerHTML = "";
      if (selectedStop.direction_N != "") {
        const optionN = document.createElement("option");
        optionN.value = "N";
        optionN.textContent = selectedStop.direction_N;
        directionSelect.appendChild(optionN);
      }
      if (selectedStop.direction_S != "") {
        const optionS = document.createElement("option");
        optionS.value = "S";
        optionS.textContent = selectedStop.direction_S;
        directionSelect.appendChild(optionS);
      }

      submitBtn.disabled = false;
    } else {

      submitBtn.disabled = true;
    }
  });

  submitBtn.addEventListener("click", () => {
    const stationId = stationSelect.value;
    const stationName = filteredStops.find(s => s.id === stationId).name;
    const direction = directionSelect.value;
    
    if (!direction) {
      alert("Please select a direction.");
      return;
    }

    var dataToBeSent = {
      'station': `${stationId}${direction}`
    }
    
    alert(`You selected: Line ${lineSearch.value} â†’ ${stationName} (${direction})\nSending ${dataToBeSent['station']}`);


    // Determine the correct return URL (emulator vs real watch)
    function getQueryParam(variable, defaultValue) {
      var query = location.search.substring(1);
      var vars = query.split('&');
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split('=');
        if (pair[0] === variable) {
          return decodeURIComponent(pair[1]);
        }
      }
      return defaultValue || false;
    }
    var return_to = getQueryParam('return_to', 'pebblejs://close#');

    document.location = return_to + encodeURIComponent(JSON.stringify(dataToBeSent));

    // alert(``);


  });


  function renderStationOptions(filter = "") {
    // stationSelect.innerHTML = "";
    stationSelectCustom.innerHTML = "";
    stationValue.removeAttribute("value");
    filteredStops
      .filter(s => s.name.toLowerCase().includes(filter.toLowerCase()))
      .forEach(s => {
        // const option = document.createElement("option");
        // option.value = s.id;
        // option.textContent = s.name;
        // stationSelect.appendChild(option);

        const divOption = document.createElement('div');
        divOption.className = 'stationSelectOption';
        divOption.id = s.id;
        divOption.textContent = s.name;
        divOption.dataset.value = s.id;
        stationSelectCustom.appendChild(divOption);

        divOption.addEventListener('click', () => {
          document.querySelectorAll('.stationSelectOption').forEach(el => el.classList.remove('selected'));
          divOption.classList.add('selected');
          stationValue.value = s.id;
          stationName.value = s.name;
        });
        
      });
  }
}

// Load data on page load
loadData();
</script>


</body>
</html>
